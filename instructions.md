### Добро пожаловать в документации о написании исполняемых инструкций AI-M



## Введение

AI-M Ассистент - это пара исполняемых инструкций:
Исполняемая инструкция предстовляет из себя текст который может содержать js-выражения и модификаторы выполняемые в разные этапы жизненого цикла инструкции, которые могут выполнять полезную работу а так же изменять саму инструкцию.

В этом документе мы разберем, как использовать новые функции и какие модификаторы доступны.

---

**Использование JavaScript-выражений**

Вы можете вставлять JavaScript-выражения прямо в текст инструкции. Например:

```
{{2+2}}  ->   '4'
```

Эти выражения будут автоматически вычислены, а их результат будет подставлен вместо выражения.

---

**Жизненный цикл запроса**

Запрос сначала проходит `prev` инструкцию, а затем `exec`. Разница между ними в том,  что `prev` сначала изменяется под действием js-выражений и модификаторов, а затем полученый результат используется для получения конечного ответа*, а `exec` после того же процесса нигде не используется, а так же в контексте выполнения добовляется переменная 'answer' - конечный ответ пользователю.
\* Только в том случае если полученый результат не является пустой строкой.

Инструкция проходит через следующие этапы:

1. **Получение исходного текста инструкции**: Исходный текст инструкции берется для последующей обработки.

2. **Выделение фрагментов с выражениями и модификаторами**: Из исходного текста инструкции выделяются все фрагменты, содержащие выражения и модификаторы.

3. **Рекурсивное выполнение фрагментов**: Выделенные фрагменты с выражениями и модификаторами выполняются рекурсивно от наиболее вложенных. Например:
   ```
   {{useGpt3('у какого домашнего животного {{5+5+6+6}} пальцев?')}}
   ```
   Будет выполнено следующим образом:
   ```
   {{useGpt3('у какого домашнего животного 12 пальцев?')}}
   ```
   Результат:
   ```
   'кошка'
   ```

4. **Использование модификаторов**: Модификаторы могут использовать API, память и модели GPT для своей работы.

5. **Получение основного ответа**: После выполнения всех фрагментов инструкции полученная инструкция используется снова с помощью модели GPT для получения основного ответа.


Этот процесс позволяет создавать более сложные и гибкие инструкции, которые могут включать в себя вычисления, обращения к памяти и внешние API.

---
**Рекурсивное использование блоков**

JavaScript-выражения и модификаторы могут использоваться рекурсивно, что позволяет создавать более сложные и гибкие инструкции.

---

## Список модификаторов

Список модификаторов с описанием и примерами использования:



1. **useGpt4**
   - **Синтаксис**: `useGpt4(text)`
   - **Описание**: Выполняет запрос к модели GPT-4 для получения ответа на заданный вопрос.
   - **Пример использования**: 
     ```
     {{useGpt4('как называется птица с синей грудкой')}}
     ```
   - **Результат**: 
     ```
     'синица'
     ```
   
2. **useGpt3**
   - **Синтаксис**: `useGpt3(text)`
   - **Описание**: Выполняет запрос к модели GPT-3 для получения ответа на заданный вопрос.
   - **Пример использования**: 
     ```
     {{useGpt3('как называется птица с синей грудкой')}}
     ```
   - **Результат**: 
     ```
     'синица'
     ```
   
3. **useIf**
   - **Синтаксис**: `useIf(condition, text)`
   - **Описание**: Вставляет текст, если условие истинно.
   - **Пример использования**: 
     ```
     {{useIf('земля плоская', 'пользователь верит в сверхестественное')}}
     ```
   - **Результат**: 
     В зависимости от значения `condition`, будет вставлен указанный текст или пустая строка.

   
4. **useIfJs**
   - **Синтаксис**: `useIfJs(conditionJs, text)`
   - **Описание**: Вставляет текст, если условие JavaScript истинно.
   - **Пример использования**: 
     ```
     {{useIfJs('webClient == "telegram"', 'Пользователь из телеграмма')}}
     ```
   - **Результат**: 
     В зависимости от значения условия JavaScript `webClient == "telegram"`, будет вставлен указанный текст или пустая строка.

   
5. **ifThen**
   - **Синтаксис**: `ifThen(condition, script)`
   - **Описание**: Выполняет скрипт, если условие истинно.
   - **Пример использования**: 
     ```
     {{ifThen('земля плоская', 'useGpt3('Как называется человек верующий в лженауку')')}}
     ```
   - **Результат**: 
     В зависимости от значения `condition`, будет выполнен указанный скрипт или модификатор и вставлен результат выполнения.

   
6. **ifThenJs**
   - **Синтаксис**: `ifThenJs(conditionJs, script)`
   - **Описание**: Выполняет скрипт, если условие JavaScript истинно.
   - **Пример использования**: 
     ```
     {{ifThenJs('webClient == "telegram"', '2+useGpt3('Верни только число каого возраста может быть пользователь')')}}
     ```
   - **Результат**: 
     В зависимости от значения условия JavaScript `webClient == "telegram"`, будет выполнен указанный скрипт или модификатор и вставлен результат выполнения.
   

7. **useDelay**
   - **Синтаксис**: `useDelay(seconds)`
   - **Описание**: Задерживает ответ на указанное количество секунд.
   - **Пример использования**: 
     ```
     {{useDelay(5)}}
     ```
   - **Результат**: 
     Ответ будет задержан на 5 секунд. В инструкции заменяется на пустую строку.
   

8. **addMess**
   - **Синтаксис**: `addMess(wait, text)`
   - **Описание**: Добавляет сообщение в диалог.
   - **Пример использования**: 
     ```
     {{addMess(5, 'Привет, как дела?')}}
     ```
   - **Результат**: 
     Сообщение "Привет, как дела?" будет добавлено в диалог через 5 секунд. В инструкции заменяется на пустую строку.
   

9. **addWelcome**
   - **Синтаксис**: `addWelcome(text)`
   - **Описание**: Добавляет приветственное сообщение при первом входе пользователя.
   - **Пример использования**: 
     ```
     {{addWelcome('Добро пожаловать на наш сервис!')}}
     ```
   - **Результат**: 
     Приветственное сообщение будет добавлено в диалог при первом входе пользователя. В инструкции заменяется на пустую строку
   

10. **setSession**
    - **Синтаксис**: `setSession(data, expire=45*24*60*60)`
    - **Описание**: Сохраняет данные в памяти сессии и доступно только конкретному клиенту.
    - **Пример использования**: 
      ```
      {{setSession({value: '2', user_preference: 'theme_dark'}, 3600}}}
      ```
    - **Результат**: 
      Строка "2" будет сохранена в сессии как  "value", а "theme_dark" как "user_preference" с временем жизни 1 час. При этом старые значения можно перезаписать. В инструкции заменяется на пустую строку.
   

11. **useSession**
    - **Синтаксис**: `useSession(param=null)`
    - **Описание**: Получает сессионные данные клиента.
    - **Пример использования**: 
      ```
      {{useSession()}} 
      ---
      {{useSession('value')}} 
      ```
    - **Результат**: 
      ```
      "value": "2", 
      "user_preference": "theme_dark"
      ---
      "2"
      ```
   

12. **memorize**
    - **Синтаксис**: `memorize(key, data, expire=45*24*60*60)`
    - **Описание**: Сохраняет данные в глобальной памяти и доступно во всех диалогах инструкции.
    - **Пример использования**: 
      ```
      {{memorize('user_preference', 'theme_dark', 3600)}}
      ```
    - **Результат**: 
      Строка "theme_dark" будет сохранена в глобальной памяти под ключом "user_preference" с временем жизни 1 час. В инструкции заменяется на пустую строку.
   

13. **useMemory**
    - **Синтаксис**: `useMemory(key)`
    - **Описание**: Получает данные из глобальной памяти.
    - **Пример использования**: 
      ```
      {{useGlobMemory('user_preference')}}
      ```
    - **Результат**: 
      ```
      'theme_dark'
      ```

   
14. **useTeam**
    - **Синтаксис**: `useTeam(name, dialog)`
    - **Описание**: Делает запрос к другому ассистенту. Можно предать диалог как массив строк где последнее от пользователя или оставить пустым - тогда передается текущий диалог
    - **Пример использования**: 
      ```
      {{useTeam('trigger', ['мы будем говорить о контенте', 'давай говорить только про копирайтинг'])}}
      ```
    - **Результат**:  В инструкции заменяется на ответ от ассистента.
15. **usePhoto**
    - **Синтаксис**: `usePhoto(search, count=1, size='512×512')`
    - **Описание**: Ищет фотографии по заданному запросу.
    - **Пример использования**: 
      ```
      {{usePhoto('красивый закат', 2)}}
      ```
    - **Результат**: 
     ```
      'https://img.freepik.com/free-photo/vibrant-sunset-reflects-beauty-in-tranquil-nature-scene-generated-by-ai_188544-25837.jpg?size=626&ext=jpg
      https://img.example2.png'
      ```
   
     
16. **useVideo**
    - **Синтаксис**: `usePhoto(search, count=1, size='512×512')`
    - **Описание**: Ищет видео по заданному запросу.
    - **Пример использования**: 
      ```
      {{usePhoto('красивый закат')}}
      ```
    - **Результат**: 
     ```
      'https://img.freepik.com/free-photo/vibrant-sunset-reflects-beauty-in-tranquil-nature-scene-generated-by-ai_188544-25837.jpg?size=626&ext=jpg'
      ```

   
17. **useDalle**
    - **Синтаксис**: `useDalle(prompt, count=1, size='512x512')`
    - **Описание**: Генерирует изображения с использованием API DALL-E.
    - **Пример использования**: 
      ```
      {{useDalle('красивый цветок', 3, '1024×1024')}}
      ```
    - **Результат**: 
      Будут сгенерированы 3 изображения размером 800x600 с запросом "красивый цветок" с помощью API DALL-E.
      ```
      'https://image-link.webp'
      ```

   
18. **fetchApi**
    - **Синтаксис**: `fetchApi(url, options)`
    - **Описание**: Выполняет HTTP-запрос к указанному URL с заданными параметрами.
    - **Пример использования**: 
      ```
      {{fetchApi('https://api.example.com/data', {method: 'GET'})}}
      ```
    - **Результат**: 
      Выполнит GET-запрос к URL 'https://api.example.com/data'. В инструкции заменяется на пустую строку.

   
19. **fetchPage**
    - **Синтаксис**: `fetchPage(url, options)`
    - **Описание**: Выполняет HTTP-запрос к указанной странице и извлекает текст из HTML-контента.
    - **Пример использования**: 
      ```
      {{fetchPage('https://example.com', {method: 'GET'})}}
      ```
    - **Результат**: 
      Выполнит GET-запрос к указанному URL 'https://example.com', извлечет текст из HTML-контента и вернет его.

   
20. **fetchJSON**
    - **Синтаксис**: `fetchJSON(url, options)`
    - **Описание**: Выполняет HTTP-запрос к указанному URL и возвращает JSON-ответ.
    - **Пример использования**: 
      ```
      {{fetchJSON('https://api.example.com/data', {method: 'GET'})}}
      ```
    - **Результат**: 
      Выполнит GET-запрос к URL 'https://api.example.com/data' и вернет JSON-строку.

   
21. **fetchText**
    - **Синтаксис**: `fetchText(url, options)`
    - **Описание**: Выполняет HTTP-запрос к указанному URL и возвращает текстовый ответ.
    - **Пример использования**: 
      ```
      {{fetchText('https://example.com', {method: 'GET'})}}
      ```
    - **Результат**: 
      Выполнит GET-запрос к указанному URL 'https://example.com' и вернет текстовый ответ.

   
22. **useWeb**
    - **Синтаксис**: `useWeb(url)`
    - **Описание**: Загружает указанную веб-страницу, извлекает текст из HTML-контента и возвращает его.
    - **Пример использования**: 
      ```
      {{useWeb('https://example.com')}}
      ```
    - **Результат**: 
      Загрузит указанную веб-страницу 'https://example.com', извлечет текст из HTML-контента и вернет его.

   
23. **useKeyManager**
    - **Синтаксис**: `useKeyManager(masterKey='getKey', diaposone=30, text="Access is denied, take the key. If the key doesn't work, get a new one")`
    - **Описание**: Если ввести в диалог  'getKey user_Tag' то в ответ будет получен ключ для активации, который работает только для пользователя с ником 'user_Tag' в указанном диапозоне дней (при том диапозон стартует от 1 января 1970 года). Если пользователь не ввел  свой ключ он получит сообщение "Access is denied, take the key. If the key doesn't work, get a new one". При том ключ время от времени проверяется занво.
    - **Пример использования**: 
      ```
      {{useKeyManager('MyKeyToCreateUsersKeys', 30, text="Access is denied.")}}
      ```
    - **Результат**: 
      Пустая строка или пользовательский ключ или сообщение "Access is denied." с блокировкой основного ответа.





Эти модификаторы предоставляют различные возможности для выполнения HTTP-запросов, обработки контента и взаимодействия с веб-ресурсами.

---


### Контекст исполнения

Помимо модификаторов, вашему скрипту доступен контекст исполнения, который включает в себя следующие элементы:

  - `clientName`: Строка, представляющая имя клиента.
  - `clientId`: Строка, представляющая идентификатор клиента.
  - `webClient`: Булево значение, указывающее, является ли клиент веб-интерфейсом.
  - (другие поля метаданных, если они присутствуют).
  - `dialog`: Массив сообщений.
- `isFirstMessage`: Булево значение, указывающее, является ли текущее сообщение первым в диалоге.
- `prompt`: Непосредственно исходный текст исполняемой инструкции.
- `answer`: Вначале это пустая строка, а к моменту выполнения `exec`  содержит полученый ответ.

Контекст предоставляет доступ к широкому набору переменных и методов JavaScript, которые могут быть использованы для выполнения различных задач. Дополнительную информацию о JavaScript можно найти в [документации MDN (Mozilla Developer Network)](https://developer.mozilla.org/en-US/docs/Web/JavaScript).
 - `Date`: Объект, представляющий текущее время. [mdn](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date)
  - `Math`: Объект, предоставляющий математические функции и константы. [mdn](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math)
  - (другие переменные и методы, доступные в среде выполнения JavaScript) [mdn](https://developer.mozilla.org/en-US/docs/Web/JavaScript)
  


## Example
Давайте создадим асистента вместе и рассмотрим разные кейсы использования.

> Мы будем сосдавать  `асистента продавца`  для автоворонок блогера-эксперта, однако нам бы не хотелось что бы этот пример ограничивал вашу фантазию на приедмет использования этого инструмента, поэтому в конце мы коротко перечислим кейсы которые удалось создать нашей команде.

-   Предположим наш эксперт продает консультации для самозанятых и обещает после занятий что клиент научиться освобождать свое время не теряя в доходе.
-   У эксперта есть "лид-магнит" - бесплатный чек лист по которому самозанятый сможет найти свои ошибки
-   Эксперт дает рекламу предлогая бесплатный чеклист, для этого необходимо написать в личные сообщения например в инстаграм.
-   Предположим эксперт ведет свою работу в google-sheets, умеет создавать опросы и открывать доступ к документам по ссылке. (В вашем случае это может быть CRM система, ваше приложение или вовсе ничего из этого)
-   **Цель**  `асистента продавца`  **отправить**  обещанный чеклист, а так же  **собрать информацию**  о клиенте и  **назначить онлайн встречу**


//будет дописанно позже

## Алея идей

[](https://github.com/AI-M-chats/docs/blob/main/instructions.md#%D0%B0%D0%BB%D0%B5%D1%8F-%D0%B8%D0%B4%D0%B5%D0%B9)

Нам бы не хотелось, что бы этот пример ограничивал вашу фантазию на приедмет использования этого инструмента, поэтому мы коротко перечислим кейсы которые удалось создать нашей команде.

-   Самое очевидное, Ассистент который сначала отдает лид-магнит (закрытое видео автора), потом продает инфо-программу + ведение ментора, через 2 месяца ассистент возвращался с вопросом о том купил ли лид программу, на сколько она понравилась и мягко закрывает либо на продажу програмы либо (если програма пройдена и все понравилось) вип-консультацию с основателем.
    
-   Date planer. Один из наших сотрудников в этапе ухаживаний, поэтому на этапе тестирования, он сделал ассистента который смотрит афишу, погоду, а так же рестораны поблизости к месту события и выдает 2-4 варианта как может пройти выходной. Теперь он всегда на готове и просто не отрозим.
    
-   Меннеджер аккаунтов. Хотя мы настаивали на том, что еще слишком рано, был создан ассистент, который получал данные с биржи, первую страницу новостных изданий и выдавал предположение о том куда двинется рынок. И второй ассистент, который можно поросить открыть сделку и он делает это для многих подключенных аккаунтов. Хотя мы не рекамендуем этот пример, примечательно что можно создавать ассистентов способных управлять большим колличеством аккаунтов.
    
-   Ассистент для поиска компании. Клиент отвечает на вопросы: каким спортом занимается, на какую площадку ходит, и ему даётся ссылка на аккаунт потенциального мэтча, а если такого не находиться то его запрос запоминается на 4 дня и он ждёт когда ему напишут.
    
-   Самопроверка сотрудников. Когда содрудник завершает задачу (например курьер), то он пишет ассистенту что он что то сделал или что почему то не сделал, ассистент используя дерево вопросов задает их сотруднику (например если что то сделать не удалось , уточнил ли причину, дату, оставил ли ключ и так далее). Сотрудник отвечая на эти вопрсы может лучше выполнить свою задачу, а так же если все супер, результат анкетирования записывается в crm, по сути фиксируя результат и ответственность за него за сотрудником
    
-   Выявление потребности. Дизайнер-планировщик работая на себя тратил уйму времени на одинаковые диалоги с клиентом что бы сформировать четкое ТЗ. На помощь пришел ассистент который принимал обращения клиентов, сразу задавал уточняющие вопросы, спрашивал что нестандартного нужно учесть и формировал правильно сформулированный запрос для дизайнера.
    
-   Школа. Целая группа простых ассистентов каждый из которых по сути дает клиенту маленькое задание, обьясняет как его нужно выполнять и просит выполнить. Далее задает проверяющие вопросы, до тех пор, пока не получиться правильный результат. Если результат не верный указывает на то, где именно ошибка, а если верный, то отправляет к следующему ассистенту. Так например команда ассистентов может научить Настраивать контекстную рекламу или делать анализ конкурентов, если разбить это действие на 5-9 супер маленьких шагов.
    
-   Новая жизнь чек-листам. Для примера мы взяли (найденный в интернете) чек-лист при покупке поддержаного авто марки vw на бензиновых турбированых моторах 2011-2019годов выпуска. В чек листе указывалась последовательность проверок и допроверок. (по сути упакован весь опыт автоподборщика). Этот чеклист нужно дополнить - например видео со звуками моторов. Документ получился обьемным, однако его можно упаковать в ассистенты. Теперь покупатель может приходить на осмотр авто с помощником в телефоне. Примечательно что чек-листы были очень популярны и можно найти много качестенных примеров: от авто до анализа бизнес структур, и если раньше для работы со сложными и обьемными чеклистами нужен был специалист, теперь клиенту нужен только ассистент.
    
-   'Рекрутер (массовый подбор)' - вакансия подразумевающая, что человек за небольшую оплату проводит первичный опрос кандидатов в соцсетях, в результате заполняет гугл-форму или форму crm. Делается это для того что бы отсеять лишних кандидатов, а подходящих ранжировать, с кем имеет смысл провести интервью сначала. Раньше это был манатонный труд, теперь достаточно пригласить кандидата написат в аккаунт с подключенным ассистентом, асистент сам проанкетирует, договориться о времени звонка если кондидат подходящий, а так же запишет результат в crm или таблицу.
    
-   Асистент помогающий сделать идиальный подарок для тех, у кого все есть. По сути ассистент задает вопросы, таким образом подбирая идиальный слоган а так же картинкуи тип мерча, после чего формируется реферальная ссылка к контрагенту где в конструкторе уже готовый вариант мерча.
    
-   AI-фрилансеры - копирайтеры, верстальщики, ux/ui дизайнеры и многие другие уже используют нейросети для ускорения своей работы. Казалось бы - зачем им ассистент, неужели в ассистент можно качественно упаковать всё разнобразие запросов? А что если ускориться еще - Асистент скурпулезно расспрашивает клиента, а в качестве результата формирует промпт для конкретного клиента.
    
-   Ассистент для генирации контента. Те кто вел свои соц-сети знает как не просто генерировать актуальный и уникальный контент, а ведь регулярность - залог успеха. А как обидно когда контент даже не смотрят. Так вот можно сделать ассистента который смотрит - что сейчас популярно и обсуждаемо, и расспрашивает автора об этом в его нише. В итоге генирируется контент план на неделю вперед.
